#!/usr/bin/env bash
# bin/compile <build-dir> <cache-dir> <env-dir>

set -exuo pipefail

BUILD_DIR=${1}
CACHE_DIR=${2}
ENV_DIR=${3}

cd $BUILD_DIR
pwd

# save space on slug
rm -rf \
  .DS_Store \
  .git/ \
  .github/ \
  .ruby-lsp/ \
  astro_charts_etc/ \
  astrolog/versions/7.60/dev/ \
  cli/ \
  design/ \
  guardrails/ \
  infra/ \
  spikes/ \
  ui/ \

cd saturn
pwd

du -sh .
du -sh * | sort -hr

EPHEMERIS_DATA_DIR="$(bundle info astroscript --path)/vendor/swe_data"

# Create a .profile.d script that sets a default only if not already provided.
mkdir -p "$BUILD_DIR/.profile.d"
{
  echo '# Set defaults without overriding user-provided config vars.'
  # The backslash before $ prevents expansion *now*; the double quotes
  # ensure the backslash is not written to the file, so the runtime shell
  # sees ${SE_EPHE_PATH:=...} correctly.
  echo ": \"\${SE_EPHE_PATH:=$EPHEMERIS_DATA_DIR}\""
  echo 'export SE_EPHE_PATH'
} > "$BUILD_DIR/.profile.d/00-aistrologer-buildpack-env.sh"

(set -x && cat "$BUILD_DIR/.profile.d/00-aistrologer-buildpack-env.sh")

# EPHEMERIS_DATA_DIR=$(bundle info astroscript --path)/vendor/swe_data
# # cp -r $EPHEMERIS_DATA_DIR $BUILD_DIR/saturn

# mkdir -p "$BUILD_DIR/.profile.d"
# # Only set defaults; do not override user-provided config vars:
# cat > "$BUILD_DIR/.profile.d/00-aistrologer-buildpack-env.sh" <<'EOF'
# : "${SE_EPHE_PATH:=EPHEMERIS_DATA_DIR}"
# export SE_EPHE_PATH
# EOF

# # cd $(bin/bundle show wkhtmltopdf-binary)/bin
# cd /app/saturn/vendor/bundle/ruby/3.2.0/gems/wkhtmltopdf-binary-0.12.6.8/bin
# mv wkhtmltopdf_ubuntu_22.04_amd64.gz /tmp/
# rm *.gz
# mv /tmp/wkhtmltopdf_ubuntu_22.04_amd64.gz ./

# TODO lock wkhtmltopdf version to ensure compatible with pdfkit
# if [[ $(wkhtmltopdf --version) != *"wkhtmltopdf 0.12.5"* ]]; then
#   echo "wkhtmltopdf version is not 0.12.5"
#   exit 1
# fi

exit 0
